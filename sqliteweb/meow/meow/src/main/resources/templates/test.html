<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>AI Biography</title>
  <link rel="stylesheet" th:href="@{/chat.css}">
</head>
<body>
<!-- å´é‚Šæ¬„é–‹é—œæŒ‰éˆ• -->
<button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>

<div class="header-buttons">
  <!-- å¤ªé™½æœˆäº®åˆ‡æ›æ¨¡å¼ -->
  <button onclick="toggleMode()">
    <span class="mode-icon" id="modeIcon">ğŸŒ™</span>
  </button>
  <!-- ç™»å…¥ç™»å‡ºæŒ‰éˆ• -->
  <form method="post" th:action="@{/logout}">
    <button type="submit">Logout</button>
  </form>
</div>

<div class="container">
  <!-- å´é‚Šæ¬„ -->
  <div class="sidebar" id="sidebar">
    <h3>æ­·å²ç´€éŒ„</h3>
    <ul id="historyList"></ul>
  </div>

  <!-- èŠå¤©å€åŸŸ -->
  <div class="chat-area" id="chatArea">
    <h2>AI Biography</h2>
    <div class="chat-box" id="chatBox"></div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
      <button onclick="sendMessage()">ç™¼é€</button>
      <!-- åŠ è™ŸæŒ‰éˆ•ç”¨ä¾†ä¸Šå‚³æª”æ¡ˆ -->
      <button class="upload-btn" onclick="document.getElementById('fileInput').click()">+</button>
      <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()"/>
    </div>
  </div>
</div>

<script>
  let messages = [];
  let history = [];
  let loggedIn = false;

  // åˆ‡æ›æ·±è‰²èˆ‡æ·ºè‰²æ¨¡å¼
  function toggleMode() {
    const body = document.body;
    body.classList.toggle('light-mode');
    const modeIcon = document.getElementById('modeIcon');
    if (body.classList.contains('light-mode')) {
      modeIcon.textContent = 'ğŸŒ';
    } else {
      modeIcon.textContent = 'ğŸŒ™';
    }
  }

  function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    if (!message) return;

    messages.push({ role: 'user', content: message });
    updateChatBox();

    // æ¨¡æ“¬ AI å›æ‡‰
    setTimeout(() => {
      const aiMessage = { role: 'ai', content: ` ${message}` };
      messages.push(aiMessage);
      updateChatBox();
      history.push(message);
      updateHistory();
    }, 1000);

    input.value = '';
  }

  function updateChatBox() {
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '';
    messages.forEach(msg => {
      chatBox.innerHTML += `<div class="message ${msg.role}">${msg.role === 'user' ? 'ä½ ' : 'AI'}: ${msg.content}</div>`;
    });
  }

  function updateHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    history.forEach(msg => {
      historyList.innerHTML += `<li>${msg}</li>`;
    });
  }

  function logout() {
    messages = [];
    history = [];
    updateChatBox();
    updateHistory();
  }

  function uploadFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];

  if (!file) {
    alert("è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆ");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  fetch("/api/resume/upload", {
    method: "POST",
    body: formData
  })
    .then(response => {
      if (!response.ok) {
        throw new Error("ä¸Šå‚³å¤±æ•—ï¼");
      }
      return response.json();
    })
    .then(data => {
      // å°‡å›å‚³çµæœé¡¯ç¤ºåœ¨ chatBox
      const aiMessage = {
  role: 'ai',
  content: `
    æª”åï¼š${data.filename}
    ç‹€æ…‹ï¼š${data.status}
    å‚™è¨»ï¼š${data.note}
    æ“·å–å…§å®¹ï¼š
    ${data.extractedText}
  `
};
      messages.push(aiMessage);
      updateChatBox();
    })
    .catch(error => {
      console.error("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
      const aiMessage = { role: 'ai', content: "âš ï¸ å±¥æ­·ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" };
      messages.push(aiMessage);
      updateChatBox();
    });

  // é‡ç½®è¼¸å…¥æ¬„
  fileInput.value = "";
}

  function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const chatArea = document.getElementById('chatArea');
      const toggleBtn = document.querySelector('.sidebar-toggle');

      const isOpen = sidebar.classList.toggle('open');
      chatArea.style.marginLeft = isOpen ? '270px' : '0';
      toggleBtn.style.left = isOpen ? '250px' : '0';
  }
</script>
</body>
</html>
